# 本地資料庫系統使用指南

## 概述

本系統建立了一個 SQLite 本地資料庫，用於儲存 FinMind 下載的台股資料，解決 API 請求限制問題。

## 優勢

✅ **節省 API 配額**：資料只下載一次，可重複使用
✅ **加快查詢速度**：本地查詢比 API 快數倍
✅ **離線使用**：資料下載後可離線查詢
✅ **自動管理**：智慧判斷資料新舊，自動更新過期資料

## 系統架構

```
┌─────────────────────────────────────────┐
│         find_high_dividend_stocks.py     │  主程式（查詢高殖利率股票）
│              ↓                           │
│    ┌─────────────────────────────┐      │
│    │  優先從資料庫讀取            │      │
│    │  ├─ 股利資料                 │      │
│    │  ├─ 股價資料                 │      │
│    │  └─ KD 指標                  │      │
│    └─────────────────────────────┘      │
│              ↓                           │
│    資料不存在或過期？                    │
│              ↓ 是                        │
│    ┌─────────────────────────────┐      │
│    │  呼叫 FinMind API            │      │
│    │  並儲存到資料庫               │      │
│    └─────────────────────────────┘      │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│         sync_data.py                     │  資料同步工具
│              ↓                           │
│    ┌─────────────────────────────┐      │
│    │  批次下載資料                │      │
│    │  ├─ 股票清單                 │      │
│    │  ├─ 股利資料                 │      │
│    │  └─ 股價資料                 │      │
│    └─────────────────────────────┘      │
│              ↓                           │
│    ┌─────────────────────────────┐      │
│    │  儲存到 SQLite 資料庫        │      │
│    │  (stock_data.db)             │      │
│    └─────────────────────────────┘      │
└─────────────────────────────────────────┘
```

## 資料庫結構

### stock_data.db

1. **stock_info** - 股票基本資訊
2. **dividend_data** - 股利資料
3. **daily_price** - 每日股價
4. **kd_indicators** - KD 指標快取
5. **api_requests** - API 請求記錄
6. **data_sync_log** - 資料同步記錄

## 快速開始

### 步驟 1：首次資料同步

```powershell
# 方案 A：同步高殖利率候選股（推薦，約 97 檔股票）
python sync_data.py --mode candidates

# 方案 B：測試模式（只同步前 10 檔）
python sync_data.py --mode test

# 方案 C：同步單一股票
python sync_data.py --stock 2330
```

執行後會看到：
```
================================================================================
🔄 批次同步股票資料
================================================================================
📊 準備同步 97 檔股票
⏱️  預估時間: 3.2 分鐘
💡 模式：智慧更新（只更新過期資料）

📊 進度: 50/97 (51.5%) | 成功: 45 股利 + 45 股價 | 錯誤: 0 | API限制: 0
...
✅ 同步完成！
```

### 步驟 2：查詢高殖利率股票

```powershell
python find_high_dividend_stocks.py
```

執行後會看到：
```
================================================================================
方法 1：使用 FinMind API 取得殖利率資料（資料庫模式）
================================================================================

💾 資料庫模式已啟用
   股票數: 97
   股利記錄: 582
   股價記錄: 24850
   資料庫大小: 2.45 MB

📊 進度: 50/97 (51.5%) - 已找到 8 檔 | DB命中: 48 | API呼叫: 2

💾 資料來源統計:
   從資料庫讀取: 95 次
   API 呼叫: 2 次
   節省 API 請求: 97.9%
```

## 命令詳解

### sync_data.py - 資料同步工具

#### 基本用法

```powershell
python sync_data.py [選項]
```

#### 同步模式

| 模式 | 說明 | 用法 |
|------|------|------|
| `candidates` | 同步高殖利率候選股（97檔）| `--mode candidates` |
| `test` | 測試模式（前10檔）| `--mode test` |
| `list` | 只更新股票清單 | `--mode list` |
| `all` | 同步所有台股（智慧模式：只下載需要的）| `--mode all` |

#### 其他選項

| 選項 | 說明 | 範例 |
|------|------|------|
| `--stock` | 指定單一股票 | `--stock 2330` |
| `--force` | 強制更新所有資料 | `--force` |

#### 使用範例

```powershell
# 1. 首次同步（推薦）
python sync_data.py --mode candidates

# 2. 更新單一股票
python sync_data.py --stock 2330

# 3. 強制重新下載所有資料
python sync_data.py --mode candidates --force

# 4. 更新股票清單
python sync_data.py --mode list

# 5. 測試 API 是否正常
python sync_data.py --mode test

# 6. 同步所有台股（智慧模式，只下載需要的）
python sync_data.py --mode all

# 7. 強制同步所有台股（需數小時，不推薦）
python sync_data.py --mode all --force
```

### find_high_dividend_stocks.py - 查詢程式

#### 基本用法

```powershell
python find_high_dividend_stocks.py
```

程式會自動：
1. 檢查資料庫是否存在
2. 優先從資料庫讀取
3. 資料過期時自動更新
4. 顯示資料來源統計

#### 環境變數控制

在 `.env` 檔案中設定：

```env
# 啟用資料庫模式（推薦）
USE_DATABASE=True

# 不使用資料庫（純 API 模式）
USE_DATABASE=False
```

## 資料更新策略

### 自動更新規則

1. **股利資料**：7 天內有效
   - 股利通常每年公告一次
   - 7 天內的資料視為最新

2. **股價資料**：1 天內有效
   - 股價每天變動
   - 隔天需重新取得

3. **智慧更新**：
   - 資料在有效期內：直接從資料庫讀取
   - 資料過期：自動從 API 更新並儲存

### 手動更新

```powershell
# 更新所有候選股資料
python sync_data.py --mode candidates --force

# 更新特定股票
python sync_data.py --stock 2330 --force
```

## 資料庫管理

### 檢查資料庫狀態

```python
from database_manager import init_database

db = init_database()
stats = db.get_database_stats()
print(f"股票數: {stats['total_stocks']}")
print(f"股利記錄: {stats['dividend_records']}")
print(f"股價記錄: {stats['price_records']}")
print(f"資料庫大小: {stats['db_size_mb']:.2f} MB")
db.close()
```

### 查看 API 使用統計

```python
from database_manager import init_database

db = init_database()
api_stats = db.get_api_request_stats(hours=24)
print(f"24小時內 API 請求: {api_stats['total_requests']}")
print(f"成功請求: {api_stats['successful_requests']}")
print(f"查詢股票數: {api_stats['unique_stocks']}")
db.close()
```

### 重置資料庫

```powershell
# 刪除資料庫檔案
Remove-Item stock_data.db

# 重新同步
python sync_data.py --mode candidates
```

## 常見問題

### Q1: 資料庫會佔用多少空間？

**A**: 約 2-5 MB（97檔候選股），全台股約 100-200 MB

### Q2: 多久需要更新一次資料？

**A**: 
- 股利資料：每月更新一次即可（自動判斷30天有效期）
- 股價資料：建議每天更新（自動判斷7天有效期）
- 程式會自動判斷並只更新過期資料

### Q3: API 仍然達到限制怎麼辦？

**A**: 
1. 確認已啟用資料庫模式（`USE_DATABASE=True`）
2. 先執行 `sync_data.py` 預先下載資料
3. 避免使用 `--force` 參數（會強制重新下載）
4. 使用智慧模式（預設），會自動跳過已下載的資料

### Q4: 資料庫損壞如何修復？

**A**:
```powershell
# 刪除舊資料庫
Remove-Item stock_data.db

# 重新建立並同步
python sync_data.py --mode candidates
```

### Q5: 可以在多台電腦間共享資料庫嗎？

**A**: 可以！將 `stock_data.db` 檔案複製到其他電腦即可。

### Q6: `--mode all` 會不會用完 API 配額？

**A**: 不會！預設使用智慧模式，只下載需要的資料：
```powershell
# 智慧模式（推薦）- 只下載缺少或過期的資料
python sync_data.py --mode all

# 強制模式 - 重新下載所有資料（需數小時，不推薦）
python sync_data.py --mode all --force
```

## 效能優化建議

1. **首次使用**
   ```powershell
   # 先同步候選股
   python sync_data.py --mode candidates
   
   # 等待完成後再查詢
   python find_high_dividend_stocks.py
   ```

2. **定期維護**
   ```powershell
   # 每天更新一次股價
   python sync_data.py --mode candidates
   ```

3. **大量查詢**
   ```powershell
   # 智慧同步所有台股（只下載需要的）
   python sync_data.py --mode all
   
   # 之後查詢幾乎不消耗 API
   python find_high_dividend_stocks.py
   ```

## 進階使用

### Python 程式中使用資料庫

```python
from database_manager import init_database

# 初始化資料庫
db = init_database()

# 讀取股利資料
dividend_data = db.get_dividend_data('2330', start_date='2022-01-01')
print(dividend_data)

# 讀取股價資料
price_data = db.get_daily_price('2330', start_date='2024-01-01')
print(price_data)

# 取得最新股價
latest_price = db.get_latest_price('2330')
print(f"最新股價: {latest_price}")

# 關閉連接
db.close()
```

### 客製化同步腳本

```python
from sync_data import DataSyncManager

# 建立同步管理器
sync = DataSyncManager()

# 自訂股票清單
my_stocks = ['2330', '2317', '2454', '2881', '2882']

# 同步資料
sync.sync_all_stocks(stock_list=my_stocks, force=False)

# 關閉
sync.close()
```

## 檔案說明

| 檔案 | 說明 |
|------|------|
| `database_manager.py` | 資料庫管理核心模組 |
| `sync_data.py` | 資料同步工具 |
| `find_high_dividend_stocks.py` | 主查詢程式（已整合資料庫） |
| `stock_data.db` | SQLite 資料庫檔案 |
| `.env` | 環境變數設定 |

## 故障排除

### 錯誤：sqlite3.OperationalError

**原因**：資料庫檔案被鎖定或損壞

**解決**：
```powershell
# 關閉所有 Python 程式
# 刪除資料庫
Remove-Item stock_data.db
# 重新同步
python sync_data.py --mode test
```

### 錯誤：KeyError: 'data'

**原因**：API 請求達到限制

**解決**：
```powershell
# 等待幾分鐘
# 或使用資料庫模式
python find_high_dividend_stocks.py
```

### 資料庫為空

**原因**：尚未同步資料

**解決**：
```powershell
python sync_data.py --mode candidates
```

## 總結

使用本地資料庫系統，您可以：
- ✅ 節省 95%+ 的 API 請求
- ✅ 加快查詢速度 10 倍以上
- ✅ 避免 API 限制問題
- ✅ 離線使用歷史資料

**建議流程**：
1. 首次執行：`python sync_data.py --mode candidates`
2. 日常查詢：`python find_high_dividend_stocks.py`
3. 每日更新：`python sync_data.py --mode candidates`（可選）
