# 交易系統通知設定說明

## 📢 功能概述

交易系統已整合 **Email 和 Telegram Bot** 雙重通知功能，可即時接收以下事件通知：

> ⚠️ **重要更新**: Line Notify 已於 2025年3月31日終止服務，推薦使用 **Telegram Bot** 作為替代方案。

### ✅ 支援的通知類型

1. **下單通知**
   - ✅ 下單成功（建倉/平倉）
   - ❌ 下單失敗
   - ⚠️ 組合單異常

2. **程式狀態通知**
   - 🚀 程式啟動
   - 🛑 程式停止（含停止原因）

3. **連線狀態通知**
   - 📡 連線中斷警告
   - ✅ 重新連線成功
   - ❌ 重新連線失敗

4. **持倉監控通知**
   - 📊 達到持倉限制（總持倉/單一標的）
   - ⚠️ 持倉異常警告（單邊持倉）

---

## 📧 Email 通知設定

### 1. Gmail 設定（推薦）

#### 步驟 1：開啟兩步驟驗證
1. 前往 [Google 帳戶安全性設定](https://myaccount.google.com/security)
2. 確保「兩步驟驗證」已啟用

#### 步驟 2：生成應用程式密碼
1. 前往 [應用程式密碼頁面](https://myaccount.google.com/apppasswords)
2. 選擇「應用程式」→ **郵件**
3. 選擇「裝置」→ **其他（自訂名稱）**
4. 輸入名稱：`交易系統通知`
5. 點擊「產生」
6. **複製生成的 16 位密碼**（不含空格）

#### 步驟 3：編輯 .env 檔案
```env
# Email 通知設定
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASSWORD=生成的16位應用程式密碼
EMAIL_TO=recipient@example.com
```

**參數說明：**
- `SMTP_USER`: 您的 Gmail 帳號
- `SMTP_PASSWORD`: 剛才生成的應用程式密碼（**不是您的 Gmail 密碼**）
- `EMAIL_TO`: 接收通知的信箱（可以是同一個或不同的信箱）

---

### 2. 其他 Email 服務商設定

#### Yahoo Mail
```env
SMTP_SERVER=smtp.mail.yahoo.com
SMTP_PORT=587
SMTP_USER=your_email@yahoo.com
SMTP_PASSWORD=應用程式專用密碼
EMAIL_TO=recipient@example.com
```

#### Outlook / Hotmail
```env
SMTP_SERVER=smtp-mail.outlook.com
SMTP_PORT=587
SMTP_USER=your_email@outlook.com
SMTP_PASSWORD=您的密碼
EMAIL_TO=recipient@example.com
```

---
## 📱 Telegram Bot 設定 ⭐ 推薦

### 為什麼選擇 Telegram？
- ✅ **完全免費**，無使用限制
- ✅ **即時推播**，訊息秒到
- ✅ **設定簡單**，5分鐘完成
- ✅ **功能強大**，支援多種訊息格式

### 快速設定步驟

#### 1. 建立 Telegram Bot
1. 在 Telegram 搜尋 `@BotFather`
2. 發送 `/newbot` 指令
3. 依照提示設定機器人名稱和用戶名
4. **複製獲得的 Bot Token**

#### 2. 獲取 Chat ID
1. 與您的機器人開始對話（發送任意訊息）
2. 在瀏覽器開啟：
   ```
   https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates
   ```
3. 找到 `"chat":{"id":123456789}` 中的數字
4. **複製這個 Chat ID**

#### 3. 設定環境變數
```env
# Telegram Bot 通知設定
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz1234567890
TELEGRAM_CHAT_ID=123456789
```

> 📖 **詳細教學**: 請參考 [Telegram設定教學.md](./Telegram設定教學.md) 獲取完整圖文教學

---
##  完整 .env 範例

```env
# ========== API 設定 ==========
SINOPAC_API_KEY=YOUR_API_KEY
SINOPAC_SECRET_KEY=YOUR_SECRET_KEY
SINOPAC_CA_PATH=C:/ekey/551/YOUR_PERSON_ID/S/Sinopac.pfx
SINOPAC_CA_PASSWORD=YOUR_CA_PASSWORD

# ========== Email 通知設定（可選）==========
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASSWORD=your_app_password_16digits
EMAIL_TO=recipient@example.com

# ========== Telegram Bot 通知設定（可選）==========
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz1234567890
TELEGRAM_CHAT_ID=123456789
```

> 💡 **提示**: Email 和 Telegram 可以只設定一個或兩個都設定（推薦）

---

## ✅ 測試通知功能

### 方法 1：執行測試腳本
```powershell
python notification_manager.py
```
- 此命令會發送測試通知到所有已設定的通道
- 檢查是否收到 Email 和 Line 通知

### 方法 2：啟動交易機器人
```powershell
# 啟動建倉機器人
python SinoPac-new.py

# 啟動平倉機器人
python SinoPac-close.py
```
- 程式啟動時會自動發送「程式啟動」通知
- 確認收到通知表示設定成功

---

## 🔔 通知範例

### Email 通知範例
```
主旨: [交易系統] 程式啟動

建倉機器人 (SinoPac-new) 已啟動

時間: 2025-01-17 09:00:00
```

### Line 通知範例
```
🚀 程式啟動
建倉機器人 (SinoPac-new) 已啟動
⏰ 2025-01-17 09:00:00
```

---

## ❓ 常見問題

### Q1: 沒有收到通知怎麼辦？

**檢查清單：**
1. ✅ `.env` 檔案是否存在且設定正確
2. ✅ Gmail 應用程式密碼是否正確（不含空格）
3. ✅ 網路連線是否正常
4. ✅ 檢查垃圾郵件資料夾

**查看日誌：**
```powershell
# 查看通知管理器日誌
Get-Content PerryLogs/notification.log -Tail 50
```

---

### Q2: Gmail 提示「不夠安全的應用程式」怎麼辦？

**解決方案：**
1. 使用「應用程式密碼」（推薦）
   - 參考上方「Gmail 設定」步驟
2. 確認兩步驟驗證已啟用
3. 不要使用 Gmail 帳號密碼，必須使用應用程式密碼

---

### Q3: 如何暫時停用通知？

**方法：註解環境變數**
```env
# SMTP_USER=your_email@gmail.com  ← 加上 # 註解
```

---

### Q4: Line Notify 為什麼不能用了？

**Line Notify 已於 2025年3月31日終止服務。**  
推薦使用 **Telegram Bot** 作為替代方案：
- ✅ 完全免費，無使用限制
- ✅ 即時推播，比 Email 更快
- ✅ 設定簡單，5分鐘完成
- 📖 詳細教學：[Telegram設定教學.md](./Telegram設定教學.md)

---

### Q5: 可以同時使用 Email 和 Telegram 嗎？

**可以！而且推薦這樣做。**

系統會自動偵測已設定的通道：
- 兩者都設定 → 同時發送（最可靠）✅
- 只設定 Email → 只透過 Email 通知
- 只設定 Telegram → 只透過 Telegram 通知
- 都不設定 → 不發送通知（但交易功能正常）

---

## 📊 通知頻率說明

| 通知類型 | 觸發頻率 |
|---------|---------|
| 程式啟動 | 每次啟動一次 |
| 程式停止 | 每次停止一次 |
| 下單成功/失敗 | 每次下單時 |
| 連線中斷 | 偵測到中斷時 |
| 重新連線 | 每次重連嘗試 |
| 持倉限制 | 達到限制時 |
| 持倉異常 | 偵測到異常時（不重複通知同一問題） |

---

## 🛡️ 安全建議

1. **保護 .env 檔案**
   - 不要將 `.env` 上傳到 Git
   - 不要分享給他人
   - 定期更換密碼

2. **使用專用信箱**
   - 建議使用專門的信箱接收交易通知
   - 避免與個人主信箱混用

3. **定期檢查**
   - 定期確認通知功能正常運作
   - 檢查是否有異常通知

---

## 📞 技術支援

如有任何問題，請檢查以下日誌檔案：
- `PerryLogs/notification.log` - 通知系統日誌
- `PerryLogs/error.log` - 錯誤日誌
- `PerryLogs/trade.log` - 交易日誌

---

**祝您交易順利！** 🎉
